<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src *; img-src * data: blob:; media-src * blob:; style-src 'self' 'unsafe-inline'; script-src 'self';">
  <title>Bsky Dreams</title>
  <!-- PWA / iOS Safari standalone support (M32) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Bsky Dreams">
  <meta name="theme-color" content="#0085ff">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <!-- ============================================================
       AUTH SCREEN ‚Äî shown when no session is stored
  ============================================================ -->
  <div id="auth-screen" class="screen" aria-label="Sign in to BlueSky">
    <div class="auth-card">
      <div class="auth-logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" width="56" height="56">
          <path d="M32 8C18.7 8 8 18.7 8 32s10.7 24 24 24 24-10.7 24-24S45.3 8 32 8z" fill="var(--color-accent)"/>
          <path d="M22 26c0-5.5 4.5-10 10-10s10 4.5 10 10c0 4-2.3 7.4-5.7 9.1L32 44l-4.3-8.9C24.3 33.4 22 30 22 26z" fill="#fff"/>
        </svg>
      </div>
      <h1 class="auth-title">Bsky Dreams</h1>
      <p class="auth-subtitle">A better window into BlueSky</p>

      <form id="auth-form" novalidate>
        <div class="field-group">
          <label for="auth-handle" class="field-label">BlueSky handle</label>
          <input
            type="text"
            id="auth-handle"
            name="handle"
            class="field-input"
            placeholder="you.bsky.social"
            autocomplete="username"
            autocapitalize="none"
            spellcheck="false"
            required
          >
        </div>
        <div class="field-group">
          <label for="auth-password" class="field-label">App Password</label>
          <input
            type="password"
            id="auth-password"
            name="password"
            class="field-input"
            placeholder="xxxx-xxxx-xxxx-xxxx"
            autocomplete="current-password"
            required
          >
          <p class="field-hint">
            Use an <a href="https://bsky.app/settings/app-passwords" target="_blank" rel="noopener">App Password</a>,
            not your main password. Generate one in BlueSky ‚Üí Settings ‚Üí App Passwords.
          </p>
        </div>
        <div id="auth-error" class="error-banner" hidden role="alert"></div>
        <button type="submit" class="btn btn-primary btn-full" id="auth-submit">
          Sign in
        </button>
      </form>
    </div>
  </div>

  <!-- ============================================================
       MAIN APP ‚Äî shown when authenticated
  ============================================================ -->
  <div id="app-screen" class="screen" hidden aria-label="Bsky Dreams main interface">

    <!-- ============================================================
         TOP BAR (M43) ‚Äî Minimal: hamburger + logo on mobile; near-invisible on desktop
    ============================================================ -->
    <header class="top-bar" role="banner">
      <div class="top-bar-inner">
        <!-- Mobile hamburger ‚Äî opens main sidebar as drawer -->
        <button class="nav-btn channels-nav-btn sidebar-hamburger" id="nav-channels-btn"
                aria-label="Open navigation" aria-expanded="false" aria-controls="channels-sidebar">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <!-- Logo visible on mobile only (desktop shows it in sidebar) -->
        <span class="nav-logo-btn mobile-logo" aria-hidden="true">
          <span class="nav-logo-mark">‚òÅ</span>
          <span class="nav-logo-text">Bsky Dreams</span>
        </span>
        <!-- Profile avatar ‚Äî mobile only; desktop shows own profile in sidebar -->
        <button class="nav-avatar-btn" id="nav-profile-btn" aria-label="Account and sign out">
          <img id="nav-avatar" src="" alt="" class="nav-avatar" aria-hidden="true">
          <span id="nav-handle" class="nav-handle-text"></span>
        </button>
      </div>
    </header>

    <!-- ============================================================
         MAIN SIDEBAR (M43) ‚Äî nav + channels; always open desktop, drawer mobile
    ============================================================ -->
    <aside id="channels-sidebar" class="channels-sidebar" aria-label="Navigation">
      <!-- Sidebar header: logo + close button (close visible on mobile only) -->
      <div class="sidebar-header">
        <button class="sidebar-logo-btn" id="nav-home-btn" aria-label="Bsky Dreams home">
          <span class="nav-logo-mark" aria-hidden="true">‚òÅ</span>
          <span class="nav-logo-text">Bsky Dreams</span>
        </button>
        <button class="sidebar-close-btn" id="sidebar-close-btn" aria-label="Close navigation">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- Own profile (desktop; populated by app.js after login) -->
      <button class="sidebar-own-profile" id="sidebar-own-profile" aria-label="Your profile" hidden>
        <img id="sidebar-own-avatar" src="" alt="" class="sidebar-own-avatar">
        <div class="sidebar-own-info">
          <span id="sidebar-own-name" class="sidebar-own-name"></span>
          <span id="sidebar-own-handle" class="sidebar-own-handle"></span>
        </div>
      </button>

      <!-- Main navigation items (same IDs as before) -->
      <nav class="sidebar-nav" aria-label="Main navigation">
        <button class="sidebar-nav-item active" id="nav-feed-btn" data-view="feed">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          <span>Home</span>
        </button>
        <button class="sidebar-nav-item" id="nav-compose-btn" data-view="compose">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          <span>Post</span>
        </button>
        <button class="sidebar-nav-item" id="nav-tv-btn" data-view="tv">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span>TV</span>
        </button>
        <button class="sidebar-nav-item" id="nav-notif-btn" data-view="notifications" aria-label="Notifications">
          <span class="sidebar-notif-wrap" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span class="notif-badge" id="notif-badge" hidden></span>
          </span>
          <span>Notifications</span>
        </button>
        <button class="sidebar-nav-item" id="nav-search-btn" data-view="search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <span>Search</span>
        </button>
      </nav>

      <!-- Channels section (no heading, just channel links at bottom) -->
      <div class="sidebar-channels-sep" aria-hidden="true"></div>
      <nav id="channels-list" class="channels-list sidebar-channels-list" aria-label="Saved channels">
        <!-- Rendered by app.js -->
      </nav>

      <!-- Footer: Sign out -->
      <div class="sidebar-footer">
        <button class="sidebar-sign-out-btn" id="sidebar-sign-out-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          <span>Sign out</span>
        </button>
      </div>
    </aside>

    <!-- Mobile sidebar backdrop -->
    <div id="sidebar-overlay" class="sidebar-overlay" hidden aria-hidden="true"></div>

    <!-- ---- HOME FEED VIEW ---- -->
    <section id="view-feed" class="view" aria-label="Home feed">
      <div class="view-inner">
        <!-- Pull-to-refresh indicator (hidden above scroll area by negative margin) -->
        <div id="ptr-indicator" class="ptr-indicator" aria-hidden="true">
          <svg class="ptr-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </div>
        <div class="feed-tabs" role="tablist" aria-label="Feed type">
          <button id="feed-tab-discover" class="feed-tab feed-tab-active" role="tab" aria-selected="true" aria-controls="feed-results">Discover</button>
          <button id="feed-tab-following" class="feed-tab" role="tab" aria-selected="false" aria-controls="feed-results">Following</button>
        </div>
        <div id="feed-results" class="feed" aria-live="polite" aria-label="Home feed">
          <div class="feed-empty">
            <p>Your following feed will appear here.</p>
          </div>
        </div>
        <div id="feed-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="feed-load-more-btn">Load more</button>
        </div>
      </div>
    </section>

    <!-- ---- SEARCH VIEW ---- -->
    <section id="view-search" class="view" hidden aria-labelledby="search-heading">
      <div class="view-inner">
        <h2 id="search-heading" class="sr-only">Search BlueSky</h2>
        <form id="search-form" class="search-bar" role="search">
          <label for="search-input" class="sr-only">Search posts, users, or topics</label>
          <input
            type="search"
            id="search-input"
            class="search-input"
            placeholder="Search posts, people, or topics‚Ä¶"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <div class="search-filters" role="group" aria-label="Search filters">
            <button type="button" class="filter-chip active" data-filter="posts">Posts</button>
            <button type="button" class="filter-chip" data-filter="users">People</button>
            <button type="button" class="filter-chip" data-filter="latest">Latest</button>
          </div>
          <!-- Adult content toggle + advanced search toggle -->
          <div class="search-options-row">
            <label class="adult-toggle-label" title="Filter posts labelled as adult content">
              <input type="checkbox" id="hide-adult-toggle" checked>
              <span>Hide adult content</span>
            </label>
            <button type="button" class="advanced-toggle-btn" id="advanced-toggle-btn"
                    aria-expanded="false" aria-controls="advanced-panel">
              Advanced <span class="adv-arrow" aria-hidden="true">‚ñæ</span>
            </button>
          </div>

          <!-- Advanced search panel (hidden by default) -->
          <div id="advanced-panel" class="advanced-panel" hidden>
            <div class="advanced-grid">
              <div class="adv-field">
                <label for="adv-author" class="adv-label">Author</label>
                <input type="text" id="adv-author" class="adv-input"
                       placeholder="handle.bsky.social"
                       autocomplete="off" autocapitalize="none" spellcheck="false">
              </div>
              <div class="adv-field">
                <label for="adv-mentions" class="adv-label">Mentions</label>
                <input type="text" id="adv-mentions" class="adv-input"
                       placeholder="handle.bsky.social"
                       autocomplete="off" autocapitalize="none" spellcheck="false">
              </div>
              <div class="adv-field">
                <label for="adv-lang" class="adv-label">Language</label>
                <input type="text" id="adv-lang" class="adv-input"
                       placeholder="en, fr, ja‚Ä¶"
                       autocomplete="off" maxlength="10">
              </div>
              <div class="adv-field">
                <label for="adv-domain" class="adv-label">Domain</label>
                <input type="text" id="adv-domain" class="adv-input"
                       placeholder="example.com"
                       autocomplete="off" autocapitalize="none">
              </div>
              <div class="adv-field">
                <label for="adv-since" class="adv-label">From date</label>
                <input type="date" id="adv-since" class="adv-input">
              </div>
              <div class="adv-field">
                <label for="adv-until" class="adv-label">To date</label>
                <input type="date" id="adv-until" class="adv-input">
              </div>
            </div>
            <!-- M49: Media type filters -->
            <div class="adv-media-row">
              <span class="adv-media-label">Has media:</span>
              <button type="button" class="adv-media-chip" data-media="image">üñº Image</button>
              <button type="button" class="adv-media-chip" data-media="video">üé¨ Video</button>
              <button type="button" class="adv-media-chip" data-media="link">üîó Link</button>
            </div>
            <p class="adv-media-note">Filters apply to fetched results ‚Äî use "Load more" to find additional matches.</p>
          </div>

          <button type="submit" class="btn btn-primary search-submit">Search</button>
        </form>

        <div id="search-results" class="feed" aria-live="polite" aria-label="Search results">
          <div class="feed-empty">
            <p>Search for posts, people, or topics on BlueSky.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ---- COMPOSE VIEW ---- -->
    <section id="view-compose" class="view" hidden aria-labelledby="compose-heading">
      <div class="view-inner">
        <h2 id="compose-heading" class="view-heading">New Post</h2>
        <form id="compose-form" class="compose-form" novalidate>
          <div class="compose-row">
            <img id="compose-avatar" src="" alt="" class="compose-avatar" aria-hidden="true">
            <div class="compose-body">
              <textarea
                id="compose-text"
                class="compose-textarea"
                placeholder="What's on your mind?"
                maxlength="300"
                rows="4"
                aria-label="Post text"
              ></textarea>
              <!-- Image previews with alt text inputs ‚Äî populated by app.js -->
              <div id="compose-images-preview" class="compose-images-preview" hidden></div>
              <!-- M41: Link preview card (injected by JS when a URL is pasted) -->
              <div id="compose-link-preview-wrap"></div>
              <!-- M41: GIF search panel (shown/hidden by JS) -->
              <div id="compose-gif-panel" class="compose-gif-panel" hidden>
                <div class="compose-gif-search-row">
                  <input type="search" id="compose-gif-input" class="compose-gif-input"
                         placeholder="Search GIFs on Klipy‚Ä¶" autocomplete="off" spellcheck="false">
                  <button type="button" class="btn btn-ghost" id="compose-gif-search-btn">Search</button>
                </div>
                <div id="compose-gif-grid" class="compose-gif-grid">
                  <p class="compose-gif-empty">Type above to search for GIFs</p>
                </div>
                <p style="font-size:0.72rem;color:var(--color-text-light);padding:0 12px 8px;">
                  Powered by Klipy ¬∑ <span id="compose-klipy-key-link" style="cursor:pointer;color:var(--color-accent);text-decoration:underline">Override API key</span>
                </p>
              </div>
              <!-- M41: Post settings panel (thread gate / quote gate) -->
              <div id="compose-settings-panel" class="compose-settings-panel" hidden>
                <div class="compose-settings-row">
                  <span class="compose-settings-label">Who can reply</span>
                  <select id="compose-reply-gate" class="compose-settings-select">
                    <option value="everyone">Everyone</option>
                    <option value="mentioned">Mentioned only</option>
                    <option value="following">Following only</option>
                  </select>
                </div>
                <div class="compose-settings-row">
                  <span class="compose-settings-label">Who can quote</span>
                  <select id="compose-quote-gate" class="compose-settings-select">
                    <option value="everyone">Everyone</option>
                    <option value="nobody">Nobody</option>
                  </select>
                </div>
              </div>
              <div class="compose-footer">
                <div class="compose-footer-left compose-toolbar">
                  <button type="button" class="compose-attach-btn" id="compose-img-btn"
                          aria-label="Attach images (up to 4)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                  </button>
                  <!-- M41: GIF picker toggle -->
                  <button type="button" class="compose-attach-btn" id="compose-gif-btn"
                          aria-label="Attach GIF" title="Search GIFs">
                    <span style="font-size:0.8rem;font-weight:700;letter-spacing:-0.5px">GIF</span>
                  </button>
                  <!-- M41: Post settings toggle -->
                  <button type="button" class="compose-attach-btn" id="compose-settings-btn"
                          aria-label="Post settings (thread gate, quote gate)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M19.07 19.07l-1.41-1.41M4.93 19.07l1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/></svg>
                  </button>
                  <input type="file" id="compose-img-input" class="sr-only"
                         accept="image/jpeg,image/png,image/gif,image/webp"
                         multiple aria-label="Choose images to attach">
                  <span class="char-count" id="compose-char-count" aria-live="polite">300</span>
                </div>
                <div class="compose-actions">
                  <div id="compose-error" class="error-banner" hidden role="alert"></div>
                  <button type="submit" class="btn btn-primary" id="compose-submit">Post</button>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div id="compose-success" class="success-banner" hidden role="status">
          Posted! <button id="compose-post-link" class="compose-view-post-link">View post ‚Üí</button>
        </div>
      </div>
    </section>

    <!-- ---- PROFILE VIEW ---- -->
    <section id="view-profile" class="view" hidden aria-labelledby="profile-heading">
      <div class="view-inner">
        <div class="thread-header">
          <button class="btn btn-ghost back-btn" id="profile-back-btn" aria-label="Go back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
            Back
          </button>
          <h2 id="profile-heading" class="thread-heading">Profile</h2>
        </div>
        <div id="profile-header" class="profile-header" aria-live="polite"></div>
        <div id="profile-feed" class="feed" aria-live="polite" aria-label="Posts by this person"></div>
        <div id="profile-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="profile-load-more-btn">Load more posts</button>
        </div>
      </div>
    </section>

    <!-- ---- TV VIEW ---- -->
    <section id="view-tv" class="view view-tv" hidden aria-labelledby="tv-heading">
      <!-- Setup screen -->
      <div id="tv-setup" class="tv-setup">
        <h2 id="tv-heading" class="tv-heading">Bsky Dreams TV</h2>
        <p class="tv-desc">Continuous video from BlueSky, playing with sound.</p>

        <button type="button" class="btn btn-primary tv-start-main-btn" id="tv-start-main-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
          Start Bsky Dreams TV
        </button>

        <p class="tv-or-label">or pick a topic</p>

        <div class="tv-chips" role="group" aria-label="Suggested topics">
          <button class="tv-chip" data-topic="nature">Nature</button>
          <button class="tv-chip" data-topic="travel">Travel</button>
          <button class="tv-chip" data-topic="music">Music</button>
          <button class="tv-chip" data-topic="cooking">Food</button>
          <button class="tv-chip" data-topic="art">Art</button>
          <button class="tv-chip" data-topic="photography">Photography</button>
          <button class="tv-chip" data-topic="animals">Animals</button>
          <button class="tv-chip" data-topic="sports">Sports</button>
          <button class="tv-chip" data-topic="gaming">Gaming</button>
          <button class="tv-chip" data-topic="technology">Tech</button>
          <button class="tv-chip" data-topic="dance">Dance</button>
          <button class="tv-chip" data-topic="science">Science</button>
        </div>

        <form id="tv-form" class="tv-form">
          <input id="tv-topic-input" class="field-input tv-topic-input" type="search"
                 placeholder="Custom topic‚Ä¶"
                 autocapitalize="none" spellcheck="false" aria-label="Custom topic or hashtag">
          <button type="submit" class="btn btn-ghost tv-search-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            Search
          </button>
        </form>

        <label class="tv-adult-label">
          <input type="checkbox" id="tv-adult-toggle">
          Show adult content
        </label>

        <button type="button" id="tv-clear-history-btn" class="tv-clear-history-btn" hidden>
          Clear watch history
        </button>
      </div>

      <!-- Player (hidden until TV starts) -->
      <div id="tv-player" class="tv-player" hidden>
        <div id="tv-video-wrap" class="tv-video-wrap">
          <div id="tv-slide-a" class="tv-slide">
            <video id="tv-video" class="tv-video" playsinline></video>
          </div>
          <div id="tv-slide-b" class="tv-slide">
            <video id="tv-video-b" class="tv-video" playsinline></video>
          </div>
          <div id="tv-overlay" class="tv-overlay">

            <!-- Auto-hide: author, text, mute + power -->
            <div id="tv-overlay-meta" class="tv-overlay-meta">
              <div class="tv-meta-top">
                <span class="tv-topic-badge" id="tv-topic-badge"></span>
                <span class="tv-queue-count" id="tv-queue-count"></span>
              </div>
              <div class="tv-meta-bottom">
                <div id="tv-author" class="tv-author" role="button" tabindex="0" aria-label="View profile">
                  <img id="tv-author-avatar" class="tv-author-avatar" src="" alt="">
                  <div>
                    <div id="tv-author-name" class="tv-author-name"></div>
                    <div id="tv-author-handle" class="tv-author-handle"></div>
                  </div>
                </div>
                <p id="tv-post-text" class="tv-post-text"></p>
                <div class="tv-playback-btns">
                  <button class="tv-ctrl-icon-btn" id="tv-mute-btn" aria-label="Mute">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15" class="tv-muted-x" style="display:none"/><line x1="17" y1="9" x2="23" y2="15" class="tv-muted-x" style="display:none"/></svg>
                  </button>
                  <button class="tv-ctrl-icon-btn" id="tv-pause-btn" aria-label="Pause">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                  </button>
                  <button class="tv-ctrl-icon-btn" id="tv-stop-btn" aria-label="Stop TV">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Always visible: like, repost, open -->
            <div class="tv-actions">
              <button class="tv-action-btn" id="tv-like-btn" aria-label="Like">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28" aria-hidden="true"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span id="tv-like-count" class="tv-action-count"></span>
              </button>
              <button class="tv-action-btn" id="tv-repost-btn" aria-label="Repost">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28" aria-hidden="true"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                <span id="tv-repost-count" class="tv-action-count"></span>
              </button>
              <button class="tv-action-btn" id="tv-open-btn" aria-label="Open post">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28" aria-hidden="true"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              </button>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- ---- NOTIFICATIONS VIEW ---- -->
    <section id="view-notifications" class="view" hidden aria-labelledby="notif-heading">
      <div class="view-inner">
        <div class="feed-header">
          <h2 id="notif-heading" class="view-heading">Notifications</h2>
          <button class="btn btn-ghost feed-refresh-btn" id="notif-refresh-btn" aria-label="Refresh notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <div id="notif-list" class="feed" aria-live="polite" aria-label="Notifications">
          <div class="feed-empty"><p>Your notifications will appear here.</p></div>
        </div>
        <div id="notif-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="notif-load-more-btn">Load more</button>
        </div>
      </div>
    </section>

    <!-- ---- THREAD / CONVERSATION VIEW ---- -->
    <section id="view-thread" class="view" hidden aria-labelledby="thread-heading">
      <div class="view-inner">
        <div class="thread-header">
          <button class="btn btn-ghost back-btn" id="thread-back-btn" aria-label="Back to search results">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
            Back
          </button>
          <h2 id="thread-heading" class="thread-heading">Conversation</h2>
        </div>

        <div id="thread-content" class="thread-content" aria-live="polite">
          <!-- Thread root + replies rendered here by app.js -->
        </div>

        <!-- Inline reply form (shown below thread) -->
        <div id="thread-reply-area" class="thread-reply-area" hidden>
          <h3 class="reply-area-heading">Reply to this post</h3>
          <form id="reply-form" class="compose-form" novalidate>
            <div class="compose-row">
              <img id="reply-avatar" src="" alt="" class="compose-avatar" aria-hidden="true">
              <div class="compose-body">
                <p class="reply-to-label">Replying to <strong id="reply-to-handle"></strong></p>
                <textarea
                  id="reply-text"
                  class="compose-textarea"
                  placeholder="Write your reply‚Ä¶"
                  maxlength="300"
                  rows="3"
                  aria-label="Reply text"
                ></textarea>
                <div class="compose-footer">
                  <span class="char-count" id="reply-char-count" aria-live="polite">300</span>
                  <div class="compose-actions">
                    <div id="reply-error" class="error-banner" hidden role="alert"></div>
                    <button type="submit" class="btn btn-primary" id="reply-submit">Reply</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

  </div><!-- /#app-screen -->

  <!-- Scroll-to-top button (M34) ‚Äî fixed, appears after scrolling 300px -->
  <button id="scroll-to-top-btn" class="scroll-to-top-btn" hidden aria-label="Scroll to top">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="20" height="20" aria-hidden="true"><path d="M18 15l-6-6-6 6"/></svg>
  </button>

  <!-- Quote Post Modal (M30) -->
  <div id="quote-modal" class="modal-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="quote-modal-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="quote-modal-title" class="modal-title">Quote Post</h2>
        <button class="modal-close-btn" id="quote-modal-close" aria-label="Close quote dialog">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <textarea id="quote-modal-text" class="compose-textarea" placeholder="Add your thoughts‚Ä¶" maxlength="300" rows="4" aria-label="Quote post text"></textarea>
      <div class="compose-footer">
        <span class="char-count" id="quote-modal-count" aria-live="polite">300</span>
        <div id="quote-modal-error" class="error-banner" hidden role="alert"></div>
      </div>
      <div id="quote-modal-preview" class="quote-modal-preview">
        <!-- Quoted post preview injected by JS -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="quote-modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="quote-modal-submit">Quote Post</button>
      </div>
    </div>
  </div>

  <!-- M51: Quote post success banner -->
  <div id="quote-success-banner" class="success-banner" hidden role="status"
       style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:500;min-width:220px;text-align:center;">
    Quote posted! <button id="quote-post-link" class="compose-view-post-link">View post ‚Üí</button>
    <button id="quote-success-close" aria-label="Dismiss" style="margin-left:8px;background:none;border:none;cursor:pointer;font-size:1rem;color:inherit;">‚úï</button>
  </div>

  <!-- ============================================================
       PROFILE DROPDOWN MENU
  ============================================================ -->
  <div id="profile-menu" class="dropdown-menu" hidden role="menu" aria-label="Account options">
    <div class="dropdown-header">
      <span id="menu-display-name" class="dropdown-display-name"></span>
      <span id="menu-handle" class="dropdown-handle"></span>
    </div>
    <button class="dropdown-item" id="menu-sign-out" role="menuitem">Sign out</button>
  </div>

  <!-- ============================================================
       IMAGE LIGHTBOX (carousel-capable)
  ============================================================ -->
  <div id="image-lightbox" class="image-lightbox" hidden role="dialog" aria-modal="true" aria-label="Image viewer">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="20" height="20" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
    <!-- Prev / Next arrows (hidden when only 1 image) -->
    <button class="lightbox-arrow lightbox-arrow-prev" id="lightbox-prev" aria-label="Previous image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <button class="lightbox-arrow lightbox-arrow-next" id="lightbox-next" aria-label="Next image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24" aria-hidden="true"><path d="M9 18l6-6-6-6"/></svg>
    </button>
    <img id="lightbox-img" src="" alt="" class="lightbox-img">
    <!-- Position indicator and caption -->
    <div class="lightbox-footer">
      <span id="lightbox-counter" class="lightbox-counter"></span>
      <p id="lightbox-caption" class="lightbox-caption"></p>
      <!-- Dot indicators -->
      <div id="lightbox-dots" class="lightbox-dots"></div>
    </div>
  </div>

  <!-- ============================================================
       REPORT MODAL
  ============================================================ -->
  <div id="report-modal" class="modal-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="report-modal-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="report-modal-title" class="modal-title">Report</h2>
        <button class="modal-close-btn" id="report-modal-close" aria-label="Close report dialog">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <p id="report-modal-subtitle" class="modal-subtitle"></p>
      <fieldset class="report-reasons" id="report-reasons">
        <legend class="sr-only">Reason for report</legend>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonSpam"> Spam</label>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonViolation"> Harassment / Hate speech</label>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonMisleading"> Misleading / Misinformation</label>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonSexual"> Sexual content</label>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonRude"> Rude or antisocial</label>
        <label class="report-reason-label"><input type="radio" name="report-reason" value="com.atproto.moderation.defs#reasonOther" checked> Other</label>
      </fieldset>
      <textarea id="report-note" class="report-note" placeholder="Optional: add more context (not required)" rows="3" maxlength="2000"></textarea>
      <div id="report-modal-error" class="error-banner" hidden role="alert"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="report-modal-cancel">Cancel</button>
        <button class="btn btn-danger" id="report-modal-submit">Submit report</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       LOADING OVERLAY
  ============================================================ -->
  <div id="loading-overlay" class="loading-overlay" hidden aria-live="assertive" aria-label="Loading">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <script src="js/hls.min.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
