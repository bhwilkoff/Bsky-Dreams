<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src *; img-src * data: blob:; media-src * blob:; style-src 'self' 'unsafe-inline'; script-src 'self';">
  <title>Bsky Dreams</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <!-- ============================================================
       AUTH SCREEN — shown when no session is stored
  ============================================================ -->
  <div id="auth-screen" class="screen" aria-label="Sign in to BlueSky">
    <div class="auth-card">
      <div class="auth-logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" width="56" height="56">
          <path d="M32 8C18.7 8 8 18.7 8 32s10.7 24 24 24 24-10.7 24-24S45.3 8 32 8z" fill="var(--color-accent)"/>
          <path d="M22 26c0-5.5 4.5-10 10-10s10 4.5 10 10c0 4-2.3 7.4-5.7 9.1L32 44l-4.3-8.9C24.3 33.4 22 30 22 26z" fill="#fff"/>
        </svg>
      </div>
      <h1 class="auth-title">Bsky Dreams</h1>
      <p class="auth-subtitle">A better window into BlueSky</p>

      <form id="auth-form" novalidate>
        <div class="field-group">
          <label for="auth-handle" class="field-label">BlueSky handle</label>
          <input
            type="text"
            id="auth-handle"
            name="handle"
            class="field-input"
            placeholder="you.bsky.social"
            autocomplete="username"
            autocapitalize="none"
            spellcheck="false"
            required
          >
        </div>
        <div class="field-group">
          <label for="auth-password" class="field-label">App Password</label>
          <input
            type="password"
            id="auth-password"
            name="password"
            class="field-input"
            placeholder="xxxx-xxxx-xxxx-xxxx"
            autocomplete="current-password"
            required
          >
          <p class="field-hint">
            Use an <a href="https://bsky.app/settings/app-passwords" target="_blank" rel="noopener">App Password</a>,
            not your main password. Generate one in BlueSky → Settings → App Passwords.
          </p>
        </div>
        <div id="auth-error" class="error-banner" hidden role="alert"></div>
        <button type="submit" class="btn btn-primary btn-full" id="auth-submit">
          Sign in
        </button>
      </form>
    </div>
  </div>

  <!-- ============================================================
       MAIN APP — shown when authenticated
  ============================================================ -->
  <div id="app-screen" class="screen" hidden aria-label="Bsky Dreams main interface">

    <!-- Top Navigation Bar -->
    <header class="top-bar" role="banner">
      <div class="top-bar-inner">
        <!-- Channels sidebar toggle (mobile only; hidden on desktop) -->
        <button class="nav-btn channels-nav-btn" id="nav-channels-btn"
                aria-label="Open channels sidebar" aria-expanded="false" aria-controls="channels-sidebar">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
          <span class="nav-label">Channels</span>
        </button>
        <button class="nav-logo-btn" id="nav-home-btn" aria-label="Bsky Dreams home">
          <span class="nav-logo-mark" aria-hidden="true">☁</span>
          <span class="nav-logo-text">Bsky Dreams</span>
        </button>
        <nav class="top-nav" aria-label="Main navigation">
          <button class="nav-btn" id="nav-feed-btn" data-view="feed">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="nav-label">Home</span>
          </button>
          <button class="nav-btn active" id="nav-search-btn" aria-current="page" data-view="search">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <span class="nav-label">Search</span>
          </button>
          <button class="nav-btn" id="nav-compose-btn" data-view="compose">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            <span class="nav-label">Post</span>
          </button>
          <button class="nav-btn" id="nav-notif-btn" data-view="notifications" aria-label="Notifications">
            <span class="nav-notif-wrap" aria-hidden="true">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span class="notif-badge" id="notif-badge" hidden></span>
            </span>
            <span class="nav-label">Alerts</span>
          </button>
        </nav>
        <button class="nav-avatar-btn" id="nav-profile-btn" aria-label="Account and sign out">
          <img id="nav-avatar" src="" alt="" class="nav-avatar" aria-hidden="true">
          <span id="nav-handle" class="nav-handle-text"></span>
        </button>
      </div>
    </header>

    <!-- ============================================================
         CHANNELS SIDEBAR (M11)
    ============================================================ -->
    <aside id="channels-sidebar" class="channels-sidebar" aria-label="Saved channels">
      <div class="sidebar-header">
        <h2 class="sidebar-heading">Channels</h2>
        <button class="sidebar-close-btn" id="sidebar-close-btn" aria-label="Close channels sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <nav id="channels-list" class="channels-list" aria-label="Saved channel list">
        <!-- Rendered by app.js -->
      </nav>
    </aside>

    <!-- Mobile sidebar backdrop -->
    <div id="sidebar-overlay" class="sidebar-overlay" hidden aria-hidden="true"></div>

    <!-- ---- HOME FEED VIEW ---- -->
    <section id="view-feed" class="view" hidden aria-labelledby="feed-heading">
      <div class="view-inner">
        <div class="feed-header">
          <h2 id="feed-heading" class="view-heading">Following</h2>
          <button class="btn btn-ghost feed-refresh-btn" id="feed-refresh-btn" aria-label="Refresh feed">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <div id="feed-results" class="feed" aria-live="polite" aria-label="Following feed">
          <div class="feed-empty">
            <p>Your following feed will appear here.</p>
          </div>
        </div>
        <div id="feed-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="feed-load-more-btn">Load more</button>
        </div>
      </div>
    </section>

    <!-- ---- SEARCH VIEW ---- -->
    <section id="view-search" class="view active" aria-labelledby="search-heading">
      <div class="view-inner">
        <h2 id="search-heading" class="sr-only">Search BlueSky</h2>
        <form id="search-form" class="search-bar" role="search">
          <label for="search-input" class="sr-only">Search posts, users, or topics</label>
          <input
            type="search"
            id="search-input"
            class="search-input"
            placeholder="Search posts, people, or topics…"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <div class="search-filters" role="group" aria-label="Search filters">
            <button type="button" class="filter-chip active" data-filter="posts">Posts</button>
            <button type="button" class="filter-chip" data-filter="users">People</button>
            <button type="button" class="filter-chip" data-filter="latest">Latest</button>
          </div>
          <!-- Adult content toggle + advanced search toggle -->
          <div class="search-options-row">
            <label class="adult-toggle-label" title="Filter posts labelled as adult content">
              <input type="checkbox" id="hide-adult-toggle" checked>
              <span>Hide adult content</span>
            </label>
            <button type="button" class="advanced-toggle-btn" id="advanced-toggle-btn"
                    aria-expanded="false" aria-controls="advanced-panel">
              Advanced <span class="adv-arrow" aria-hidden="true">▾</span>
            </button>
          </div>

          <!-- Advanced search panel (hidden by default) -->
          <div id="advanced-panel" class="advanced-panel" hidden>
            <div class="advanced-grid">
              <div class="adv-field">
                <label for="adv-author" class="adv-label">Author</label>
                <input type="text" id="adv-author" class="adv-input"
                       placeholder="handle.bsky.social"
                       autocomplete="off" autocapitalize="none" spellcheck="false">
              </div>
              <div class="adv-field">
                <label for="adv-mentions" class="adv-label">Mentions</label>
                <input type="text" id="adv-mentions" class="adv-input"
                       placeholder="handle.bsky.social"
                       autocomplete="off" autocapitalize="none" spellcheck="false">
              </div>
              <div class="adv-field">
                <label for="adv-lang" class="adv-label">Language</label>
                <input type="text" id="adv-lang" class="adv-input"
                       placeholder="en, fr, ja…"
                       autocomplete="off" maxlength="10">
              </div>
              <div class="adv-field">
                <label for="adv-domain" class="adv-label">Domain</label>
                <input type="text" id="adv-domain" class="adv-input"
                       placeholder="example.com"
                       autocomplete="off" autocapitalize="none">
              </div>
              <div class="adv-field">
                <label for="adv-since" class="adv-label">From date</label>
                <input type="date" id="adv-since" class="adv-input">
              </div>
              <div class="adv-field">
                <label for="adv-until" class="adv-label">To date</label>
                <input type="date" id="adv-until" class="adv-input">
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary search-submit">Search</button>
        </form>

        <div id="search-results" class="feed" aria-live="polite" aria-label="Search results">
          <div class="feed-empty">
            <p>Search for posts, people, or topics on BlueSky.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ---- COMPOSE VIEW ---- -->
    <section id="view-compose" class="view" hidden aria-labelledby="compose-heading">
      <div class="view-inner">
        <h2 id="compose-heading" class="view-heading">New Post</h2>
        <form id="compose-form" class="compose-form" novalidate>
          <div class="compose-row">
            <img id="compose-avatar" src="" alt="" class="compose-avatar" aria-hidden="true">
            <div class="compose-body">
              <textarea
                id="compose-text"
                class="compose-textarea"
                placeholder="What's on your mind?"
                maxlength="300"
                rows="4"
                aria-label="Post text"
              ></textarea>
              <!-- Image previews with alt text inputs — populated by app.js -->
              <div id="compose-images-preview" class="compose-images-preview" hidden></div>
              <div class="compose-footer">
                <div class="compose-footer-left">
                  <button type="button" class="compose-attach-btn" id="compose-img-btn"
                          aria-label="Attach images (up to 4)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                  </button>
                  <input type="file" id="compose-img-input" class="sr-only"
                         accept="image/jpeg,image/png,image/gif,image/webp"
                         multiple aria-label="Choose images to attach">
                  <span class="char-count" id="compose-char-count" aria-live="polite">300</span>
                </div>
                <div class="compose-actions">
                  <div id="compose-error" class="error-banner" hidden role="alert"></div>
                  <button type="submit" class="btn btn-primary" id="compose-submit">Post</button>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div id="compose-success" class="success-banner" hidden role="status">
          Posted! <a id="compose-post-link" href="#" target="_blank" rel="noopener">View on BlueSky ↗</a>
        </div>
      </div>
    </section>

    <!-- ---- PROFILE VIEW ---- -->
    <section id="view-profile" class="view" hidden aria-labelledby="profile-heading">
      <div class="view-inner">
        <div class="thread-header">
          <button class="btn btn-ghost back-btn" id="profile-back-btn" aria-label="Go back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
            Back
          </button>
          <h2 id="profile-heading" class="thread-heading">Profile</h2>
        </div>
        <div id="profile-header" class="profile-header" aria-live="polite"></div>
        <div id="profile-feed" class="feed" aria-live="polite" aria-label="Posts by this person"></div>
        <div id="profile-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="profile-load-more-btn">Load more posts</button>
        </div>
      </div>
    </section>

    <!-- ---- NOTIFICATIONS VIEW ---- -->
    <section id="view-notifications" class="view" hidden aria-labelledby="notif-heading">
      <div class="view-inner">
        <div class="feed-header">
          <h2 id="notif-heading" class="view-heading">Notifications</h2>
          <button class="btn btn-ghost feed-refresh-btn" id="notif-refresh-btn" aria-label="Refresh notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Refresh
          </button>
        </div>
        <div id="notif-list" class="feed" aria-live="polite" aria-label="Notifications">
          <div class="feed-empty"><p>Your notifications will appear here.</p></div>
        </div>
        <div id="notif-load-more" class="feed-load-more" hidden>
          <button class="btn btn-ghost" id="notif-load-more-btn">Load more</button>
        </div>
      </div>
    </section>

    <!-- ---- THREAD / CONVERSATION VIEW ---- -->
    <section id="view-thread" class="view" hidden aria-labelledby="thread-heading">
      <div class="view-inner">
        <div class="thread-header">
          <button class="btn btn-ghost back-btn" id="thread-back-btn" aria-label="Back to search results">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
            Back
          </button>
          <h2 id="thread-heading" class="thread-heading">Conversation</h2>
        </div>

        <div id="thread-content" class="thread-content" aria-live="polite">
          <!-- Thread root + replies rendered here by app.js -->
        </div>

        <!-- Inline reply form (shown below thread) -->
        <div id="thread-reply-area" class="thread-reply-area" hidden>
          <h3 class="reply-area-heading">Reply to this post</h3>
          <form id="reply-form" class="compose-form" novalidate>
            <div class="compose-row">
              <img id="reply-avatar" src="" alt="" class="compose-avatar" aria-hidden="true">
              <div class="compose-body">
                <p class="reply-to-label">Replying to <strong id="reply-to-handle"></strong></p>
                <textarea
                  id="reply-text"
                  class="compose-textarea"
                  placeholder="Write your reply…"
                  maxlength="300"
                  rows="3"
                  aria-label="Reply text"
                ></textarea>
                <div class="compose-footer">
                  <span class="char-count" id="reply-char-count" aria-live="polite">300</span>
                  <div class="compose-actions">
                    <div id="reply-error" class="error-banner" hidden role="alert"></div>
                    <button type="submit" class="btn btn-primary" id="reply-submit">Reply</button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

  </div><!-- /#app-screen -->

  <!-- ============================================================
       PROFILE DROPDOWN MENU
  ============================================================ -->
  <div id="profile-menu" class="dropdown-menu" hidden role="menu" aria-label="Account options">
    <div class="dropdown-header">
      <span id="menu-display-name" class="dropdown-display-name"></span>
      <span id="menu-handle" class="dropdown-handle"></span>
    </div>
    <button class="dropdown-item" id="menu-sign-out" role="menuitem">Sign out</button>
  </div>

  <!-- ============================================================
       IMAGE LIGHTBOX (carousel-capable)
  ============================================================ -->
  <div id="image-lightbox" class="image-lightbox" hidden role="dialog" aria-modal="true" aria-label="Image viewer">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="20" height="20" aria-hidden="true"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
    <!-- Prev / Next arrows (hidden when only 1 image) -->
    <button class="lightbox-arrow lightbox-arrow-prev" id="lightbox-prev" aria-label="Previous image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <button class="lightbox-arrow lightbox-arrow-next" id="lightbox-next" aria-label="Next image">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24" aria-hidden="true"><path d="M9 18l6-6-6-6"/></svg>
    </button>
    <img id="lightbox-img" src="" alt="" class="lightbox-img">
    <!-- Position indicator and caption -->
    <div class="lightbox-footer">
      <span id="lightbox-counter" class="lightbox-counter"></span>
      <p id="lightbox-caption" class="lightbox-caption"></p>
      <!-- Dot indicators -->
      <div id="lightbox-dots" class="lightbox-dots"></div>
    </div>
  </div>

  <!-- ============================================================
       LOADING OVERLAY
  ============================================================ -->
  <div id="loading-overlay" class="loading-overlay" hidden aria-live="assertive" aria-label="Loading">
    <div class="spinner" aria-hidden="true"></div>
  </div>

  <script src="js/hls.min.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
